VTU DIARY AUTOMATION - SYSTEM ARCHITECTURE
==========================================

┌─────────────────────────────────────────────────────────────┐
│                    USER INTERACTION LAYER                    │
│                                                              │
│  Web Browser ──────────────> http://localhost:5000         │
│      │                                                       │
│      │ Paste raw notes                                      │
│      │ Click submit                                         │
│      └──────> Status updates (polling)                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                  WEB SERVER LAYER (FastAPI)                  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Routes:                                             │  │
│  │  • GET  /        → Serve HTML UI                    │  │
│  │  • POST /submit  → Accept diary content             │  │
│  │  • GET  /status  → Return progress                  │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
│  BackgroundTasks: run_automation_task() (async)             │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                   AI PROCESSING LAYER                        │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  LLM Client (src/llm_client.py)                     │   │
│  │  ├─ Gemini Provider                                 │   │
│  │  ├─ OpenAI Provider                                 │   │
│  │  └─ Mock Provider (testing)                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  Input: Raw text notes                                      │
│  Output: Structured JSON                                    │
│         {                                                    │
│           "date": "2026-02-10",                             │
│           "entry_text": "...",     # 120-180 words         │
│           "activities": [...],                              │
│           "declaration": "...",                             │
│           "confidence_score": 85,                           │
│           "uncertainties": [...]                            │
│         }                                                    │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                  VALIDATION LAYER                            │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Pydantic Models (src/diary_formatter.py)           │   │
│  │  • DiaryEntry                                       │   │
│  │  • Activity                                         │   │
│  │  • Field validation                                 │   │
│  │  • Word count check (120-180)                      │   │
│  └─────────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                 TRANSFORMATION LAYER                         │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  transform_to_form_data() (main.py)                 │   │
│  │                                                      │   │
│  │  DiaryEntry JSON → Form Data                       │   │
│  │                                                      │   │
│  │  • description  ← entry_text                       │   │
│  │  • hours        ← calculate from activities        │   │
│  │  • learnings    ← extract from activities          │   │
│  │  • blockers     ← extract from uncertainties       │   │
│  │  • links        ← extract from artifacts           │   │
│  │  • skill_ids    ← default value                    │   │
│  └─────────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│       BROWSER AUTOMATION LAYER (Selenium or Playwright)      │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  VTUSubmitter / VTUSubmitterPlaywright              │   │
│  │  (src/selenium_submit.py or src/playwright/)        │   │
│  │                                                      │   │
│  │  1. Setup Chrome Driver                            │   │
│  │     • Headless mode (configurable)                 │   │
│  │     • User agent spoofing                          │   │
│  │     • Anti-detection measures                      │   │
│  │                                                      │   │
│  │  2. Authentication (src/core/auth.py)               │   │
│  │     • Load saved session (if exists)               │   │
│  │     • Auto-login with credentials                  │   │
│  │     • Fallback to manual login                     │   │
│  │                                                      │   │
│  │  3. Navigation (src/core/navigation.py)             │   │
│  │     • Navigate to diary page                       │   │
│  │     • Handle internship selection                  │   │
│  │     • Handle date picker                           │   │
│  │                                                      │   │
│  │  4. Form Filling (src/core/form.py)                │   │
│  │     • Multiple selector fallbacks                  │   │
│  │     • Event triggering (input/change/blur)         │   │
│  │     • React form compatibility                     │   │
│  │     • Retry logic (3 attempts)                     │   │
│  │                                                      │   │
│  │  5. Session Management (src/core/session.py)        │   │
│  │     • Save cookies after successful login          │   │
│  │     • Persist to disk (sessions/ folder)           │   │
│  └─────────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                      TARGET SYSTEM                           │
│                                                              │
│              VTU Internyet Portal                           │
│         https://vtu.internyet.in                            │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • Login Page                                       │   │
│  │  • Dashboard                                        │   │
│  │  • Student Diary Entry Form                        │   │
│  │  • Submission Confirmation                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘


DATA PERSISTENCE
================

sessions/
  └── default_cookies.pkl      # Saved login cookies

logs/
  └── app.log                   # Application logs

screenshots/
  └── error_attempt_N.png       # Debug screenshots on error


CONFIGURATION
=============

.env.docker
  • LLM_PROVIDER              # gemini or openai
  • GEMINI_API_KEY            # AI API key
  • VTU_EMAIL                 # Portal credentials
  • VTU_PASSWORD              # Portal credentials
  • BROWSER_ENGINE            # selenium or playwright
  • SELENIUM_HEADLESS         # true/false
  • PORT                      # Web server port
  • LOG_LEVEL                 # DEBUG/INFO/WARNING/ERROR

system_prompts/
  └── diary_generator_system.txt   # AI behavior config


DOCKER CONTAINER
================

┌─────────────────────────────────────────────────┐
│  Container: vtu-diary-bot                       │
│  Image: Python 3.11 slim + Chrome              │
│                                                 │
│  Ports:                                         │
│    5000:5000  (Web UI)                         │
│                                                 │
│  Volumes:                                       │
│    ./sessions       → /app/sessions            │
│    ./logs           → /app/logs                │
│    ./system_prompts → /app/system_prompts      │
│                                                 │
│  Environment: .env.docker                      │
│  Shared Memory: 2GB (for Chrome)               │
└─────────────────────────────────────────────────┘


ERROR HANDLING
==============

Level 1: Selector Fallbacks
  • Try 3-5 different selectors per field
  • CSS, XPath, ID, Name variations

Level 2: Retry Logic
  • Retry entire form fill up to 3 times
  • 2 second delay between attempts

Level 3: Screenshot Capture
  • Save browser state on error
  • screenshots/error_attempt_N.png

Level 4: User Notification
  • Return error via /status endpoint
  • Display in red UI


SECURITY MEASURES
=================

1. Credentials
   • Environment variables only
   • .gitignore for .env.docker
   • No hardcoded secrets

2. Session Cookies
   • Encrypted by browser
   • Stored locally only
   • Auto-expire (24h)

3. API Keys
   • Not logged
   • HTTPS transmission only

4. Browser
   • Sandboxed in Docker
   • No persistent profile
   • Limited permissions


PERFORMANCE PROFILE
===================

Typical Execution:
  • AI Processing:    3-10s
  • Login:            2-5s
  • Form Fill:        2-4s
  • Total:            10-20s

Resource Usage:
  • Memory:  ~600MB
  • CPU:     Low (I/O bound)
  • Disk:    ~1GB (Docker image)


EXTENSION POINTS
================

1. Add AI Provider
   → Implement in src/core/llm/

2. Customize AI Behavior
   → Edit system_prompts/diary_generator_system.txt
   → Update skills list for dropdown matching

3. Switch Browser Engine
   → Set BROWSER_ENGINE=selenium or playwright
  → See docs/guides/browser-switching.md for details

4. Add Form Fields
   → Update src/core/form.py (Selenium)
   → Update src/playwright/form.py (Playwright)

5. Change Transformation
   → Modify transform_to_form_data() in main.py

6. Add Notification
   → Implement send_email() in app.py


MONITORING
==========

Real-time Status:
  • Frontend polls /status every 1s
  • Shows current stage and message
  • Color-coded UI updates

Logging:
  • Application logs → logs/app.log
  • Docker logs → docker compose logs
  • Debug mode → LOG_LEVEL=DEBUG

Health Check:
  • Web UI accessible → System OK
  • 404/500 errors → Check docker compose logs
  • Form fails → Check screenshots/
