<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTU Diary Automation - Bulk Submit</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        .history-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input[type="file"], input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        input[type="file"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .progress-container {
            display: none;
            margin-top: 30px;
        }
        .progress-bar-bg {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        .status-text {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .help-text {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
        }
        .feature-badge {
            display: inline-block;
            background: #764ba2;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            transition: border 0.3s;
        }
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
        }
        .mode-btn.small {
            padding: 8px 15px;
            font-size: 13px;
        }
        .mode-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .date-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .date-tag .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }
        .date-tag .remove:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/history" class="history-btn">üìú View History</a>
        <span class="feature-badge">‚ú® v2.0 - AI-Powered Bulk Submission</span>
        <h1>üöÄ VTU Diary Automation</h1>
        <p class="subtitle">Submit months of diary entries in minutes with AI assistance</p>

        <form id="bulkForm">
            <!-- Input Mode Toggle -->
            <div class="form-group">
                <label>üìù Input Mode</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button type="button" class="mode-btn active" onclick="switchMode('file')" id="fileModeBtn">
                        üìÅ Upload File
                    </button>
                    <button type="button" class="mode-btn" onclick="switchMode('text')" id="textModeBtn">
                        ‚úçÔ∏è Enter Text
                    </button>
                </div>
            </div>

            <!-- File Upload Mode -->
            <div class="form-group" id="fileInputGroup">
                <label for="inputFile">üìÅ Input File</label>
                <input type="file" id="inputFile" name="file" accept=".txt,.xlsx,.xls,.csv,.pdf,.mp3,.wav,.m4a,.mp4">
                <p class="help-text">Supports: Excel, PDF, Text, Audio (MP3/WAV), Video (MP4)</p>
            </div>

            <!-- Text Input Mode -->
            <div class="form-group" id="textInputGroup" style="display: none;">
                <label for="inputText">‚úçÔ∏è Enter Your Notes</label>
                <textarea id="inputText" name="text" rows="8" placeholder="Example:
January 15-17: Worked on Flask REST API development. Implemented user authentication with JWT tokens, created CRUD endpoints for main entities, and wrote unit tests using pytest. Fixed several bugs related to token validation.

Or just list activities:
- Python REST API development
- JWT authentication
- Unit testing
- Bug fixes"></textarea>
                <p class="help-text">Enter your internship activities, notes, or keywords. The AI will expand them into full diary entries.</p>
            </div>

            <div class="form-group">
                <label for="dateRange">üìÖ Select Dates</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button type="button" class="mode-btn small" onclick="switchDateMode('range')" id="rangeModeBtn">
                        üìÜ Date Range
                    </button>
                    <button type="button" class="mode-btn small active" onclick="switchDateMode('picker')" id="pickerModeBtn">
                        üìÖ Calendar Picker
                    </button>
                </div>

                <!-- Text Range Input -->
                <input type="text" id="dateRange" name="date_range" placeholder="2025-01-01 to 2025-01-31" style="display: none;">

                <!-- Calendar Picker -->
                <input type="text" id="datePicker" placeholder="Click to select dates from calendar" readonly>
                <div id="selectedDatesDisplay" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
                    <strong>Selected Dates:</strong>
                    <div id="selectedDatesList" style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
                <p class="help-text" id="dateHelpText">Select multiple dates (even non-consecutive) from the calendar. Click dates to toggle selection.</p>
            </div>

            <div class="form-group">
                <label>‚öôÔ∏è Options</label>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="skip_weekends" checked>
                        Skip Weekends
                    </label>
                    <label>
                        <input type="checkbox" name="skip_holidays" checked>
                        Skip Holidays
                    </label>
                    <label>
                        <input type="checkbox" name="dry_run">
                        Dry Run (Preview Only)
                    </label>
                </div>
            </div>

            <button type="submit" class="btn" id="submitBtn">
                üî• Generate & Preview
            </button>
        </form>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="status-text" id="statusText">Initializing...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const form = document.getElementById('bulkForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');

        let currentInputMode = 'file';
        let currentDateMode = 'picker';
        let selectedDates = [];
        let datePicker = null;

        // Initialize Flatpickr calendar
        document.addEventListener('DOMContentLoaded', () => {
            datePicker = flatpickr("#datePicker", {
                mode: "multiple",
                dateFormat: "Y-m-d",
                inline: false,
                minDate: "2020-01-01",
                maxDate: new Date().fp_incr(365), // 1 year from now
                onChange: function(selectedDatesArray, dateStr, instance) {
                    selectedDates = selectedDatesArray;
                    updateSelectedDatesDisplay();
                }
            });
        });

        function switchMode(mode) {
            currentInputMode = mode;

            if (mode === 'file') {
                document.getElementById('fileInputGroup').style.display = 'block';
                document.getElementById('textInputGroup').style.display = 'none';
                document.getElementById('fileModeBtn').classList.add('active');
                document.getElementById('textModeBtn').classList.remove('active');
                document.getElementById('inputFile').required = true;
                document.getElementById('inputText').required = false;
            } else {
                document.getElementById('fileInputGroup').style.display = 'none';
                document.getElementById('textInputGroup').style.display = 'block';
                document.getElementById('fileModeBtn').classList.remove('active');
                document.getElementById('textModeBtn').classList.add('active');
                document.getElementById('inputFile').required = false;
                document.getElementById('inputText').required = true;
            }
        }

        function switchDateMode(mode) {
            currentDateMode = mode;

            if (mode === 'range') {
                document.getElementById('dateRange').style.display = 'block';
                document.getElementById('datePicker').style.display = 'none';
                document.getElementById('selectedDatesDisplay').style.display = 'none';
                document.getElementById('rangeModeBtn').classList.add('active');
                document.getElementById('pickerModeBtn').classList.remove('active');
                document.getElementById('dateRange').required = true;
                document.getElementById('dateHelpText').textContent = 'Examples: "2025-01-15", "last month", "2025-01-01 to 2025-01-31"';
            } else {
                document.getElementById('dateRange').style.display = 'none';
                document.getElementById('datePicker').style.display = 'block';
                if (selectedDates.length > 0) {
                    document.getElementById('selectedDatesDisplay').style.display = 'block';
                }
                document.getElementById('rangeModeBtn').classList.remove('active');
                document.getElementById('pickerModeBtn').classList.add('active');
                document.getElementById('dateRange').required = false;
                document.getElementById('dateHelpText').textContent = 'Select multiple dates (even non-consecutive) from the calendar. Click dates to toggle selection.';
            }
        }

        function updateSelectedDatesDisplay() {
            const display = document.getElementById('selectedDatesDisplay');
            const list = document.getElementById('selectedDatesList');

            if (selectedDates.length === 0) {
                display.style.display = 'none';
                return;
            }

            display.style.display = 'block';

            // Sort dates
            const sortedDates = selectedDates.sort((a, b) => a - b);

            // Create date tags
            list.innerHTML = sortedDates.map((date, index) => {
                // Format date in local timezone (not UTC)
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                return `
                    <span class="date-tag">
                        ${dateStr}
                        <span class="remove" onclick="removeDate(${index})">√ó</span>
                    </span>
                `;
            }).join('');
        }

        function removeDate(index) {
            selectedDates.splice(index, 1);
            datePicker.setDate(selectedDates);
            updateSelectedDatesDisplay();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Show progress
            progressContainer.style.display = 'block';
            submitBtn.disabled = true;
            statusText.className = 'status-text';
            statusText.textContent = 'Uploading file...';

            try {
                let uploadId;

                // Step 1: Upload file or text
                if (currentInputMode === 'file') {
                    const fileInput = document.getElementById('inputFile');
                    if (!fileInput.files || !fileInput.files[0]) {
                        throw new Error('Please select a file');
                    }

                    const fileFormData = new FormData();
                    fileFormData.append('file', fileInput.files[0]);

                    statusText.textContent = 'Uploading file...';

                    const uploadResponse = await fetch('/api/upload-file', {
                        method: 'POST',
                        body: fileFormData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('File upload failed');
                    }

                    const uploadData = await uploadResponse.json();
                    uploadId = uploadData.upload_id;
                } else {
                    // Text input mode
                    const textInput = document.getElementById('inputText');
                    if (!textInput.value.trim()) {
                        throw new Error('Please enter some text');
                    }

                    statusText.textContent = 'Processing text input...';

                    const textFormData = new FormData();
                    textFormData.append('text', textInput.value);

                    const uploadResponse = await fetch('/api/upload-text', {
                        method: 'POST',
                        body: textFormData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Text upload failed');
                    }

                    const uploadData = await uploadResponse.json();
                    uploadId = uploadData.upload_id;
                }

                // Step 2: Generate preview
                statusText.textContent = 'Generating diary entries with AI...';

                const previewFormData = new FormData();
                previewFormData.append('upload_id', uploadId);

                // Handle date input
                let dateRangeValue;
                if (currentDateMode === 'range') {
                    dateRangeValue = document.getElementById('dateRange').value;
                    if (!dateRangeValue.trim()) {
                        throw new Error('Please enter a date range');
                    }
                } else {
                    // Calendar picker mode
                    if (selectedDates.length === 0) {
                        throw new Error('Please select at least one date from the calendar');
                    }
                    // Convert selected dates to comma-separated list (using local timezone, not UTC)
                    dateRangeValue = selectedDates
                        .sort((a, b) => a - b)
                        .map(d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`)
                        .join(',');
                }

                previewFormData.append('date_range', dateRangeValue);
                previewFormData.append('skip_weekends', document.querySelector('input[name="skip_weekends"]').checked);
                previewFormData.append('skip_holidays', document.querySelector('input[name="skip_holidays"]').checked);

                const previewResponse = await fetch('/api/generate-preview', {
                    method: 'POST',
                    body: previewFormData
                });

                if (!previewResponse.ok) {
                    throw new Error('Preview generation failed');
                }

                const previewData = await previewResponse.json();

                // Store preview data in sessionStorage
                sessionStorage.setItem('preview_data', JSON.stringify(previewData));

                // Redirect to approval page
                window.location.href = `/approval?session=${previewData.session_id}`;

            } catch (error) {
                statusText.className = 'status-text error';
                statusText.textContent = `‚ùå Error: ${error.message}`;
                submitBtn.disabled = false;
            }
        });

        function updateProgress(progress) {
            const percent = ((progress.completed + progress.failed) / progress.total) * 100;
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';

            statusText.textContent =
                `${progress.current}\n` +
                `‚úÖ Success: ${progress.completed} | ‚ùå Failed: ${progress.failed} | Total: ${progress.total}`;

            if (progress.status === 'completed') {
                statusText.className = 'status-text success';
                statusText.textContent =
                    `‚úÖ All done! Successfully submitted ${progress.completed} entries!`;
                submitBtn.disabled = false;
            } else if (progress.status === 'failed') {
                statusText.className = 'status-text error';
                submitBtn.disabled = false;
            }
        }

        async function pollProgress(sessionId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${sessionId}`);
                    const progress = await response.json();
                    updateProgress(progress);

                    if (progress.status === 'completed' || progress.status === 'failed') {
                        clearInterval(interval);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(interval);
                }
            }, 1000);
        }
    </script>
</body>
</html>
